import { createEffect, createSignal, onMount, type Accessor, type Component, type Setter } from "solid-js";
import "./Beaker.css"
import { constrain, getSVGCoords } from "../../ts/helpers";
import { Portal } from "solid-js/web";
import { createMemo } from "solid-js";

type SignalT = [get: Accessor<number>, set: Setter<number>];

// Struct to keep the state for the beaker
export type RectState = {
  idx: number;
  x: number;
  y: number;
  value: number;
  blocking: number | null; // stacking order
};

interface BeakerProps {
  idx: number;
  initialX: number;
  initialY: number;
  value: number;
  blocking: number | null;
  update: (idx: number, patch: Partial<RectState>) => void;
  block: (which: number, value: SignalT | null) => void;
  isBlocked: () => Array<SignalT | null>;
  valueSignal?: SignalT;
};

const minY = 550;

export const Beaker: Component<BeakerProps> = (props) => {
  // local position signals to make dragging snappy
  const [x, setX] = createSignal(props.initialX);
  const [y, setY] = createSignal(props.initialY);
  const [modalDisplay, setModalDisplay] = createSignal(false);
  const [overflow, setOverflow] = createSignal(false);
  // If a stable valueSignal was provided by the parent, use it. Otherwise create a local one.
  const local = props.valueSignal ?? createSignal(props.value);
  const [val, setVal] = local;

  let [blocked, setBlocked] = createSignal<number | null> (props.blocking);

  // Anytime the volume is set, check if it was overflowed
  let overflowTimer: number | null = null;
  createEffect(() => {
    if (val() > 2877 && blocked() !== null) {
      // Overflowing
      setOverflow(true);
      setVal(2872.5);
    }
    if (overflow()) {
      // Set/reset a timer to cancel the overflowing
      if (overflowTimer !== null) clearTimeout(overflowTimer);
      overflowTimer = setTimeout(() => { setOverflow(false); overflowTimer = null; }, 100);
    }
  });

  // Coordinate logic wrapper so we can place on scale, etc
  const setCoords = (x: number, y: number) => {
    // Ensure the beaker is always on the table
    x = constrain(x, 0, 1043);
    y = constrain(y, minY, 655);
    const b = blocked();

    // Left drain
    if (x > 30 && x < 200 && y < 610) {
        // If left drain is blocked, do nothing
        if (props.isBlocked()[0] !== null) return;

        // Set position
        x = 112;
        y = 576;
        // Set blocking
        setBlocked(0);
        props.block(0, [val, setVal]);
    }
    // Scale
    else if (x > 443 && x < 713) {
      // See if something is on the first beaker slot
      if ((props.isBlocked()[1] === null && b !== 2) || b === 1) {
        // Set position
        x = 568;
        y = 540;
        // Set blocking
        if (b !== 1) setBlocked(1);
        props.block(1, [val, setVal]);
      }
      // First slot is blocked; second must be full
      else {
        // Set position
        x = 598;
        y = 555;
        // Set blocking
        setBlocked(2);
        props.block(2, [val, setVal]);
      }
    }
    // Right drain
    else if (x > 840 && x < 1010 && y < 610) {
        // If right drain is blocked, do 
        if (props.isBlocked()[3] !== null) return;

        // Set position
        x = 922;
        y = 576;
        // Set blocking
        setBlocked(3);
        props.block(3, [val, setVal]);
    }
    // None
    else if (b !== null) {
      // console.log(`Unblocking trigger`)
      props.block(b, null);
      setBlocked(null);
    }

    // Update the x and y coordinates
    setX(x);
    setY(y);
  }

  // Drag events
  const start = (e: MouseEvent) => {
    e.preventDefault();
    const coords = getSVGCoords(e);
    let mozX = x() - coords.x;
    let mozY = y() - coords.y;
    
    const onMove = (ev: MouseEvent) => {
      const coords = getSVGCoords(ev);
      const dx = coords.x - x();
      const dy = coords.y - y();

      const newX = x() + dx + mozX;
      const newY = y() + dy + mozY;
      setCoords(newX, newY);
      props.update(props.idx, { x: x(), y: y(), blocking: blocked() });
    };

    const end = () => {
      // Remove event listeners
      window.removeEventListener("pointermove", onMove);
      window.removeEventListener("pointerup", end);
      if (blocked() === null) setModalDisplay(true);
    };

    window.addEventListener("pointermove", onMove);
    window.addEventListener("pointerup", end);
  };

  onMount(() => {
    setCoords(props.initialX, props.initialY);
  });

  let ref!: SVGGElement;

  return (<>
    <g class="beaker drag-exempt-slippery" transform={`translate(${x()}, ${y()})`} onPointerDown={start}>
      <BeakerFill vol={val} />
      <g id="beakerBody" ref={ref}>
      <g id="Rectangle 3">
      <mask id="path-2-inside-1_4_7" fill="white">
      <path d="M1 2H88V116C88 119.314 85.3137 122 82 122H7C3.68629 122 1 119.314 1 116V2Z"/>
      </mask>
      <path d="M1 2H88H1ZM92 116C92 121.523 87.5229 126 82 126H7C1.47715 126 -3 121.523 -3 116H5C5 117.105 5.89543 118 7 118H82C83.1046 118 84 117.105 84 116H92ZM7 126C1.47715 126 -3 121.523 -3 116V2H5V116C5 117.105 5.89543 118 7 118V126ZM92 2V116C92 121.523 87.5229 126 82 126V118C83.1046 118 84 117.105 84 116V2H92Z" fill="#D5D5D5" mask="url(#path-2-inside-1_4_7)"/>
      </g>
      <path id="Rectangle 1" d="M87.5 2.5V116C87.5 119.038 85.0376 121.5 82 121.5H7C3.96243 121.5 1.5 119.038 1.5 116V2.5H87.5Z" fill="url(#paint0_linear_4_7)" fill-opacity="0.2" stroke="black"/>
      <rect id="Rectangle 2" x="0.5" y="0.5" width="89" height="3" rx="1.5" fill="#D5D5D5" stroke="black"/>
      </g>
      <g id="ticks">
        <path d="M45.5247 20.4233V20.0398L46.965 18.4631C47.1341 18.2784 47.2733 18.1179 47.3826 17.9815C47.492 17.8438 47.573 17.7145 47.6255 17.5938C47.6795 17.4716 47.7065 17.3438 47.7065 17.2102C47.7065 17.0568 47.6696 16.924 47.5957 16.8118C47.5233 16.6996 47.4238 16.6129 47.2974 16.5518C47.171 16.4908 47.0289 16.4602 46.8713 16.4602C46.7037 16.4602 46.5574 16.495 46.4324 16.5646C46.3088 16.6328 46.2129 16.7287 46.1447 16.8523C46.0779 16.9759 46.0446 17.1207 46.0446 17.2869H45.5417C45.5417 17.0312 45.6007 16.8068 45.7186 16.6136C45.8365 16.4205 45.997 16.2699 46.2001 16.1619C46.4047 16.054 46.6341 16 46.8883 16C47.144 16 47.3706 16.054 47.568 16.1619C47.7654 16.2699 47.9203 16.4155 48.0325 16.5987C48.1447 16.782 48.2008 16.9858 48.2008 17.2102C48.2008 17.3707 48.1717 17.5277 48.1135 17.6811C48.0566 17.8331 47.9572 18.0028 47.8152 18.1903C47.6745 18.3764 47.4792 18.6037 47.2292 18.8722L46.2491 19.9205V19.9545H48.2775V20.4233H45.5247Z" fill="black"/>
        <path d="M50.5211 20.483C50.2711 20.483 50.046 20.4332 49.8457 20.3338C49.6454 20.2344 49.4849 20.098 49.3642 19.9247C49.2434 19.7514 49.1774 19.554 49.166 19.3324H49.6774C49.6973 19.5298 49.7868 19.6932 49.9458 19.8224C50.1064 19.9503 50.2981 20.0142 50.5211 20.0142C50.7001 20.0142 50.8592 19.9723 50.9984 19.8885C51.139 19.8047 51.2491 19.6896 51.3287 19.5433C51.4096 19.3956 51.4501 19.2287 51.4501 19.0426C51.4501 18.8523 51.4082 18.6825 51.3244 18.5334C51.242 18.3828 51.1284 18.2642 50.9835 18.1776C50.8386 18.0909 50.6731 18.0469 50.487 18.0455C50.3535 18.044 50.2164 18.0646 50.0758 18.1072C49.9352 18.1484 49.8194 18.2017 49.7285 18.267L49.2342 18.2074L49.4984 16.0597H51.7654V16.5284H49.9416L49.7882 17.8153H49.8137C49.9032 17.7443 50.0154 17.6854 50.1504 17.6385C50.2853 17.5916 50.426 17.5682 50.5723 17.5682C50.8393 17.5682 51.0772 17.6321 51.286 17.7599C51.4963 17.8864 51.661 18.0597 51.7804 18.2798C51.9011 18.5 51.9615 18.7514 51.9615 19.0341C51.9615 19.3125 51.899 19.5611 51.774 19.7798C51.6504 19.9972 51.4799 20.169 51.2626 20.2955C51.0453 20.4205 50.7981 20.483 50.5211 20.483Z" fill="black"/>
        <path d="M54.2312 20.483C53.9102 20.483 53.6367 20.3956 53.4109 20.2209C53.185 20.0447 53.0124 19.7898 52.8931 19.456C52.7738 19.1207 52.7141 18.7159 52.7141 18.2415C52.7141 17.7699 52.7738 17.3672 52.8931 17.0334C53.0138 16.6982 53.1871 16.4425 53.413 16.2663C53.6403 16.0888 53.913 16 54.2312 16C54.5494 16 54.8214 16.0888 55.0472 16.2663C55.2745 16.4425 55.4478 16.6982 55.5671 17.0334C55.6879 17.3672 55.7482 17.7699 55.7482 18.2415C55.7482 18.7159 55.6886 19.1207 55.5692 19.456C55.4499 19.7898 55.2773 20.0447 55.0515 20.2209C54.8256 20.3956 54.5522 20.483 54.2312 20.483ZM54.2312 20.0142C54.5494 20.0142 54.7965 19.8608 54.9727 19.554C55.1488 19.2472 55.2369 18.8097 55.2369 18.2415C55.2369 17.8636 55.1964 17.5419 55.1154 17.2763C55.0359 17.0107 54.9208 16.8082 54.7702 16.669C54.6211 16.5298 54.4414 16.4602 54.2312 16.4602C53.9158 16.4602 53.6694 16.6158 53.4918 16.9268C53.3143 17.2365 53.2255 17.6747 53.2255 18.2415C53.2255 18.6193 53.2653 18.9403 53.3448 19.2045C53.4244 19.4688 53.5387 19.6697 53.6879 19.8075C53.8384 19.9453 54.0195 20.0142 54.2312 20.0142Z" fill="black"/>
        <path d="M57.9812 20.483C57.6602 20.483 57.3867 20.3956 57.1609 20.2209C56.935 20.0447 56.7624 19.7898 56.6431 19.456C56.5238 19.1207 56.4641 18.7159 56.4641 18.2415C56.4641 17.7699 56.5238 17.3672 56.6431 17.0334C56.7638 16.6982 56.9371 16.4425 57.163 16.2663C57.3903 16.0888 57.663 16 57.9812 16C58.2994 16 58.5714 16.0888 58.7972 16.2663C59.0245 16.4425 59.1978 16.6982 59.3171 17.0334C59.4379 17.3672 59.4982 17.7699 59.4982 18.2415C59.4982 18.7159 59.4386 19.1207 59.3192 19.456C59.1999 19.7898 59.0273 20.0447 58.8015 20.2209C58.5756 20.3956 58.3022 20.483 57.9812 20.483ZM57.9812 20.0142C58.2994 20.0142 58.5465 19.8608 58.7227 19.554C58.8988 19.2472 58.9869 18.8097 58.9869 18.2415C58.9869 17.8636 58.9464 17.5419 58.8654 17.2763C58.7859 17.0107 58.6708 16.8082 58.5202 16.669C58.3711 16.5298 58.1914 16.4602 57.9812 16.4602C57.6658 16.4602 57.4194 16.6158 57.2418 16.9268C57.0643 17.2365 56.9755 17.6747 56.9755 18.2415C56.9755 18.6193 57.0153 18.9403 57.0948 19.2045C57.1744 19.4688 57.2887 19.6697 57.4379 19.8075C57.5884 19.9453 57.7695 20.0142 57.9812 20.0142Z" fill="black"/>
        <path d="M62.0039 20.4233V17.1506H62.4897V17.6619H62.5323C62.6005 17.4872 62.7106 17.3516 62.8626 17.255C63.0146 17.157 63.1971 17.108 63.4102 17.108C63.6261 17.108 63.8058 17.157 63.9492 17.255C64.0941 17.3516 64.207 17.4872 64.288 17.6619H64.3221C64.4059 17.4929 64.5316 17.3587 64.6992 17.2592C64.8668 17.1584 65.0678 17.108 65.3022 17.108C65.5948 17.108 65.8342 17.1996 66.0202 17.3828C66.2063 17.5646 66.2994 17.848 66.2994 18.233V20.4233H65.7965V18.233C65.7965 17.9915 65.7305 17.8189 65.5984 17.7152C65.4663 17.6115 65.3107 17.5597 65.1317 17.5597C64.9016 17.5597 64.7234 17.6293 64.5969 17.7685C64.4705 17.9062 64.4073 18.081 64.4073 18.2926V20.4233H63.896V18.1818C63.896 17.9957 63.8356 17.8459 63.7148 17.7322C63.5941 17.6172 63.4386 17.5597 63.2482 17.5597C63.1175 17.5597 62.9954 17.5945 62.8817 17.6641C62.7695 17.7337 62.6786 17.8303 62.609 17.9538C62.5408 18.076 62.5067 18.2173 62.5067 18.3778V20.4233H62.0039Z" fill="black"/>
        <path d="M67.2869 20.4233V16.0597H67.8153V19.9545H69.8438V20.4233H67.2869Z" fill="black"/>
        <path d="M45.1135 40.4233V40.0398L46.5539 38.4631C46.7229 38.2784 46.8621 38.1179 46.9715 37.9815C47.0809 37.8438 47.1618 37.7145 47.2144 37.5938C47.2684 37.4716 47.2954 37.3438 47.2954 37.2102C47.2954 37.0568 47.2584 36.924 47.1846 36.8118C47.1121 36.6996 47.0127 36.6129 46.8863 36.5518C46.7599 36.4908 46.6178 36.4602 46.4601 36.4602C46.2925 36.4602 46.1462 36.495 46.0212 36.5646C45.8976 36.6328 45.8018 36.7287 45.7336 36.8523C45.6668 36.9759 45.6334 37.1207 45.6334 37.2869H45.1306C45.1306 37.0313 45.1895 36.8068 45.3074 36.6136C45.4253 36.4205 45.5858 36.2699 45.789 36.1619C45.9935 36.054 46.2229 36 46.4772 36C46.7329 36 46.9594 36.054 47.1569 36.1619C47.3543 36.2699 47.5091 36.4155 47.6214 36.5987C47.7336 36.782 47.7897 36.9858 47.7897 37.2102C47.7897 37.3707 47.7606 37.5277 47.7023 37.6811C47.6455 37.8331 47.5461 38.0028 47.404 38.1903C47.2634 38.3764 47.0681 38.6037 46.8181 38.8722L45.838 39.9205V39.9545H47.8664V40.4233H45.1135Z" fill="black"/>
        <path d="M50.1697 40.483C49.8486 40.483 49.5752 40.3956 49.3493 40.2209C49.1235 40.0447 48.9509 39.7898 48.8316 39.456C48.7123 39.1207 48.6526 38.7159 48.6526 38.2415C48.6526 37.7699 48.7123 37.3672 48.8316 37.0334C48.9523 36.6982 49.1256 36.4425 49.3515 36.2663C49.5787 36.0888 49.8515 36 50.1697 36C50.4878 36 50.7599 36.0888 50.9857 36.2663C51.213 36.4425 51.3863 36.6982 51.5056 37.0334C51.6263 37.3672 51.6867 37.7699 51.6867 38.2415C51.6867 38.7159 51.627 39.1207 51.5077 39.456C51.3884 39.7898 51.2158 40.0447 50.99 40.2209C50.7641 40.3956 50.4907 40.483 50.1697 40.483ZM50.1697 40.0142C50.4878 40.0142 50.735 39.8608 50.9111 39.554C51.0873 39.2472 51.1753 38.8097 51.1753 38.2415C51.1753 37.8636 51.1349 37.5419 51.0539 37.2763C50.9743 37.0107 50.8593 36.8082 50.7087 36.669C50.5596 36.5298 50.3799 36.4602 50.1697 36.4602C49.8543 36.4602 49.6079 36.6158 49.4303 36.9268C49.2528 37.2365 49.164 37.6747 49.164 38.2415C49.164 38.6193 49.2037 38.9403 49.2833 39.2045C49.3628 39.4688 49.4772 39.6697 49.6263 39.8075C49.7769 39.9453 49.958 40.0142 50.1697 40.0142Z" fill="black"/>
        <path d="M53.9197 40.483C53.5986 40.483 53.3252 40.3956 53.0993 40.2209C52.8735 40.0447 52.7009 39.7898 52.5816 39.456C52.4623 39.1207 52.4026 38.7159 52.4026 38.2415C52.4026 37.7699 52.4623 37.3672 52.5816 37.0334C52.7023 36.6982 52.8756 36.4425 53.1015 36.2663C53.3287 36.0888 53.6015 36 53.9197 36C54.2378 36 54.5099 36.0888 54.7357 36.2663C54.963 36.4425 55.1363 36.6982 55.2556 37.0334C55.3763 37.3672 55.4367 37.7699 55.4367 38.2415C55.4367 38.7159 55.377 39.1207 55.2577 39.456C55.1384 39.7898 54.9658 40.0447 54.74 40.2209C54.5141 40.3956 54.2407 40.483 53.9197 40.483ZM53.9197 40.0142C54.2378 40.0142 54.485 39.8608 54.6611 39.554C54.8373 39.2472 54.9253 38.8097 54.9253 38.2415C54.9253 37.8636 54.8849 37.5419 54.8039 37.2763C54.7243 37.0107 54.6093 36.8082 54.4587 36.669C54.3096 36.5298 54.1299 36.4602 53.9197 36.4602C53.6043 36.4602 53.3579 36.6158 53.1803 36.9268C53.0028 37.2365 52.914 37.6747 52.914 38.2415C52.914 38.6193 52.9537 38.9403 53.0333 39.2045C53.1128 39.4688 53.2272 39.6697 53.3763 39.8075C53.5269 39.9453 53.708 40.0142 53.9197 40.0142Z" fill="black"/>
        <path d="M57.6697 40.483C57.3486 40.483 57.0752 40.3956 56.8493 40.2209C56.6235 40.0447 56.4509 39.7898 56.3316 39.456C56.2123 39.1207 56.1526 38.7159 56.1526 38.2415C56.1526 37.7699 56.2123 37.3672 56.3316 37.0334C56.4523 36.6982 56.6256 36.4425 56.8515 36.2663C57.0787 36.0888 57.3515 36 57.6697 36C57.9878 36 58.2599 36.0888 58.4857 36.2663C58.713 36.4425 58.8863 36.6982 59.0056 37.0334C59.1263 37.3672 59.1867 37.7699 59.1867 38.2415C59.1867 38.7159 59.127 39.1207 59.0077 39.456C58.8884 39.7898 58.7158 40.0447 58.49 40.2209C58.2641 40.3956 57.9907 40.483 57.6697 40.483ZM57.6697 40.0142C57.9878 40.0142 58.235 39.8608 58.4111 39.554C58.5873 39.2472 58.6753 38.8097 58.6753 38.2415C58.6753 37.8636 58.6349 37.5419 58.5539 37.2763C58.4743 37.0107 58.3593 36.8082 58.2087 36.669C58.0596 36.5298 57.8799 36.4602 57.6697 36.4602C57.3543 36.4602 57.1079 36.6158 56.9303 36.9268C56.7528 37.2365 56.664 37.6747 56.664 38.2415C56.664 38.6193 56.7037 38.9403 56.7833 39.2045C56.8628 39.4688 56.9772 39.6697 57.1263 39.8075C57.2769 39.9453 57.458 40.0142 57.6697 40.0142Z" fill="black"/>
        <path d="M46.6193 56.0597V60.4233H46.0909V56.6136H46.0653L45 57.321V56.7841L46.0909 56.0597H46.6193Z" fill="black"/>
        <path d="M49.2379 60.483C48.9879 60.483 48.7628 60.4332 48.5625 60.3338C48.3622 60.2344 48.2017 60.098 48.081 59.9247C47.9602 59.7514 47.8942 59.554 47.8828 59.3324H48.3942C48.4141 59.5298 48.5036 59.6932 48.6626 59.8224C48.8232 59.9503 49.0149 60.0142 49.2379 60.0142C49.4169 60.0142 49.576 59.9723 49.7152 59.8885C49.8558 59.8047 49.9659 59.6896 50.0455 59.5433C50.1264 59.3956 50.1669 59.2287 50.1669 59.0426C50.1669 58.8523 50.125 58.6825 50.0412 58.5334C49.9588 58.3828 49.8452 58.2642 49.7003 58.1776C49.5554 58.0909 49.3899 58.0469 49.2038 58.0455C49.0703 58.044 48.9332 58.0646 48.7926 58.1072C48.652 58.1484 48.5362 58.2017 48.4453 58.267L47.951 58.2074L48.2152 56.0597H50.4822V56.5284H48.6584L48.505 57.8153H48.5305C48.62 57.7443 48.7322 57.6854 48.8672 57.6385C49.0021 57.5916 49.1428 57.5682 49.2891 57.5682C49.5561 57.5682 49.794 57.6321 50.0028 57.7599C50.2131 57.8864 50.3778 58.0597 50.4972 58.2798C50.6179 58.5 50.6783 58.7514 50.6783 59.0341C50.6783 59.3125 50.6158 59.5611 50.4908 59.7798C50.3672 59.9972 50.1967 60.169 49.9794 60.2955C49.7621 60.4205 49.5149 60.483 49.2379 60.483Z" fill="black"/>
        <path d="M52.948 60.483C52.627 60.483 52.3535 60.3956 52.1277 60.2209C51.9018 60.0447 51.7292 59.7898 51.6099 59.456C51.4906 59.1207 51.4309 58.7159 51.4309 58.2415C51.4309 57.7699 51.4906 57.3672 51.6099 57.0334C51.7306 56.6982 51.9039 56.4425 52.1298 56.2663C52.3571 56.0888 52.6298 56 52.948 56C53.2662 56 53.5382 56.0888 53.764 56.2663C53.9913 56.4425 54.1646 56.6982 54.2839 57.0334C54.4047 57.3672 54.465 57.7699 54.465 58.2415C54.465 58.7159 54.4054 59.1207 54.286 59.456C54.1667 59.7898 53.9941 60.0447 53.7683 60.2209C53.5424 60.3956 53.269 60.483 52.948 60.483ZM52.948 60.0142C53.2662 60.0142 53.5133 59.8608 53.6895 59.554C53.8656 59.2472 53.9537 58.8097 53.9537 58.2415C53.9537 57.8636 53.9132 57.5419 53.8322 57.2763C53.7527 57.0107 53.6376 56.8082 53.487 56.669C53.3379 56.5298 53.1582 56.4602 52.948 56.4602C52.6326 56.4602 52.3862 56.6158 52.2086 56.9268C52.0311 57.2365 51.9423 57.6747 51.9423 58.2415C51.9423 58.6193 51.9821 58.9403 52.0616 59.2045C52.1412 59.4687 52.2555 59.6697 52.4047 59.8075C52.5552 59.9453 52.7363 60.0142 52.948 60.0142Z" fill="black"/>
        <path d="M56.698 60.483C56.377 60.483 56.1035 60.3956 55.8777 60.2209C55.6518 60.0447 55.4792 59.7898 55.3599 59.456C55.2406 59.1207 55.1809 58.7159 55.1809 58.2415C55.1809 57.7699 55.2406 57.3672 55.3599 57.0334C55.4806 56.6982 55.6539 56.4425 55.8798 56.2663C56.1071 56.0888 56.3798 56 56.698 56C57.0162 56 57.2882 56.0888 57.514 56.2663C57.7413 56.4425 57.9146 56.6982 58.0339 57.0334C58.1547 57.3672 58.215 57.7699 58.215 58.2415C58.215 58.7159 58.1554 59.1207 58.036 59.456C57.9167 59.7898 57.7441 60.0447 57.5183 60.2209C57.2924 60.3956 57.019 60.483 56.698 60.483ZM56.698 60.0142C57.0162 60.0142 57.2633 59.8608 57.4395 59.554C57.6156 59.2472 57.7037 58.8097 57.7037 58.2415C57.7037 57.8636 57.6632 57.5419 57.5822 57.2763C57.5027 57.0107 57.3876 56.8082 57.237 56.669C57.0879 56.5298 56.9082 56.4602 56.698 56.4602C56.3826 56.4602 56.1362 56.6158 55.9586 56.9268C55.7811 57.2365 55.6923 57.6747 55.6923 58.2415C55.6923 58.6193 55.7321 58.9403 55.8116 59.2045C55.8912 59.4687 56.0055 59.6697 56.1547 59.8075C56.3052 59.9453 56.4863 60.0142 56.698 60.0142Z" fill="black"/>
        <path d="M47.0695 76.0597V80.4233H46.5411V76.6136H46.5155L45.4502 77.321V76.7841L46.5411 76.0597H47.0695Z" fill="black"/>
        <path d="M49.7478 80.483C49.4268 80.483 49.1533 80.3956 48.9275 80.2209C48.7016 80.0447 48.529 79.7898 48.4097 79.456C48.2904 79.1207 48.2307 78.7159 48.2307 78.2415C48.2307 77.7699 48.2904 77.3672 48.4097 77.0334C48.5305 76.6982 48.7037 76.4425 48.9296 76.2663C49.1569 76.0888 49.4296 76 49.7478 76C50.066 76 50.338 76.0888 50.5638 76.2663C50.7911 76.4425 50.9644 76.6982 51.0837 77.0334C51.2045 77.3672 51.2648 77.7699 51.2648 78.2415C51.2648 78.7159 51.2052 79.1207 51.0858 79.456C50.9665 79.7898 50.7939 80.0447 50.5681 80.2209C50.3422 80.3956 50.0688 80.483 49.7478 80.483ZM49.7478 80.0142C50.066 80.0142 50.3131 79.8608 50.4893 79.554C50.6654 79.2472 50.7535 78.8097 50.7535 78.2415C50.7535 77.8636 50.713 77.5419 50.632 77.2763C50.5525 77.0107 50.4374 76.8082 50.2868 76.669C50.1377 76.5298 49.958 76.4602 49.7478 76.4602C49.4324 76.4602 49.186 76.6158 49.0084 76.9268C48.8309 77.2365 48.7421 77.6747 48.7421 78.2415C48.7421 78.6193 48.7819 78.9403 48.8614 79.2045C48.941 79.4687 49.0553 79.6697 49.2045 79.8075C49.355 79.9453 49.5361 80.0142 49.7478 80.0142Z" fill="black"/>
        <path d="M53.4978 80.483C53.1768 80.483 52.9033 80.3956 52.6775 80.2209C52.4516 80.0447 52.279 79.7898 52.1597 79.456C52.0404 79.1207 51.9807 78.7159 51.9807 78.2415C51.9807 77.7699 52.0404 77.3672 52.1597 77.0334C52.2805 76.6982 52.4537 76.4425 52.6796 76.2663C52.9069 76.0888 53.1796 76 53.4978 76C53.816 76 54.088 76.0888 54.3138 76.2663C54.5411 76.4425 54.7144 76.6982 54.8337 77.0334C54.9545 77.3672 55.0148 77.7699 55.0148 78.2415C55.0148 78.7159 54.9552 79.1207 54.8358 79.456C54.7165 79.7898 54.5439 80.0447 54.3181 80.2209C54.0922 80.3956 53.8188 80.483 53.4978 80.483ZM53.4978 80.0142C53.816 80.0142 54.0631 79.8608 54.2393 79.554C54.4154 79.2472 54.5035 78.8097 54.5035 78.2415C54.5035 77.8636 54.463 77.5419 54.382 77.2763C54.3025 77.0107 54.1874 76.8082 54.0368 76.669C53.8877 76.5298 53.708 76.4602 53.4978 76.4602C53.1824 76.4602 52.936 76.6158 52.7584 76.9268C52.5809 77.2365 52.4921 77.6747 52.4921 78.2415C52.4921 78.6193 52.5319 78.9403 52.6114 79.2045C52.691 79.4687 52.8053 79.6697 52.9545 79.8075C53.105 79.9453 53.2861 80.0142 53.4978 80.0142Z" fill="black"/>
        <path d="M57.2478 80.483C56.9268 80.483 56.6533 80.3956 56.4275 80.2209C56.2016 80.0447 56.029 79.7898 55.9097 79.456C55.7904 79.1207 55.7307 78.7159 55.7307 78.2415C55.7307 77.7699 55.7904 77.3672 55.9097 77.0334C56.0305 76.6982 56.2037 76.4425 56.4296 76.2663C56.6569 76.0888 56.9296 76 57.2478 76C57.566 76 57.838 76.0888 58.0638 76.2663C58.2911 76.4425 58.4644 76.6982 58.5837 77.0334C58.7045 77.3672 58.7648 77.7699 58.7648 78.2415C58.7648 78.7159 58.7052 79.1207 58.5858 79.456C58.4665 79.7898 58.2939 80.0447 58.0681 80.2209C57.8422 80.3956 57.5688 80.483 57.2478 80.483ZM57.2478 80.0142C57.566 80.0142 57.8131 79.8608 57.9893 79.554C58.1654 79.2472 58.2535 78.8097 58.2535 78.2415C58.2535 77.8636 58.213 77.5419 58.132 77.2763C58.0525 77.0107 57.9374 76.8082 57.7868 76.669C57.6377 76.5298 57.458 76.4602 57.2478 76.4602C56.9324 76.4602 56.686 76.6158 56.5084 76.9268C56.3309 77.2365 56.2421 77.6747 56.2421 78.2415C56.2421 78.6193 56.2819 78.9403 56.3614 79.2045C56.441 79.4687 56.5553 79.6697 56.7045 79.8075C56.855 79.9453 57.0361 80.0142 57.2478 80.0142Z" fill="black"/>
        <path d="M48.8434 100.483C48.5934 100.483 48.3683 100.433 48.168 100.334C47.9677 100.234 47.8072 100.098 47.6864 99.9247C47.5657 99.7514 47.4996 99.554 47.4883 99.3324H47.9996C48.0195 99.5298 48.109 99.6932 48.2681 99.8224C48.4286 99.9503 48.6204 100.014 48.8434 100.014C49.0224 100.014 49.1815 99.9723 49.3207 99.8885C49.4613 99.8047 49.5714 99.6896 49.6509 99.5433C49.7319 99.3956 49.7724 99.2287 49.7724 99.0426C49.7724 98.8523 49.7305 98.6825 49.6467 98.5334C49.5643 98.3828 49.4506 98.2642 49.3058 98.1776C49.1609 98.0909 48.9954 98.0469 48.8093 98.0455C48.6758 98.044 48.5387 98.0646 48.3981 98.1072C48.2575 98.1484 48.1417 98.2017 48.0508 98.267L47.5565 98.2074L47.8207 96.0597H50.0877V96.5284H48.2638L48.1104 97.8153H48.136C48.2255 97.7443 48.3377 97.6854 48.4727 97.6385C48.6076 97.5916 48.7482 97.5682 48.8945 97.5682C49.1616 97.5682 49.3995 97.6321 49.6083 97.7599C49.8185 97.8864 49.9833 98.0597 50.1026 98.2798C50.2234 98.5 50.2837 98.7514 50.2837 99.0341C50.2837 99.3125 50.2212 99.5611 50.0962 99.7798C49.9727 99.9972 49.8022 100.169 49.5849 100.295C49.3675 100.42 49.1204 100.483 48.8434 100.483Z" fill="black"/>
        <path d="M52.5534 100.483C52.2324 100.483 51.959 100.396 51.7331 100.221C51.5073 100.045 51.3347 99.7898 51.2154 99.456C51.0961 99.1207 51.0364 98.7159 51.0364 98.2415C51.0364 97.7699 51.0961 97.3672 51.2154 97.0334C51.3361 96.6982 51.5094 96.4425 51.7353 96.2663C51.9625 96.0888 52.2353 96 52.5534 96C52.8716 96 53.1436 96.0888 53.3695 96.2663C53.5968 96.4425 53.7701 96.6982 53.8894 97.0334C54.0101 97.3672 54.0705 97.7699 54.0705 98.2415C54.0705 98.7159 54.0108 99.1207 53.8915 99.456C53.7722 99.7898 53.5996 100.045 53.3738 100.221C53.1479 100.396 52.8745 100.483 52.5534 100.483ZM52.5534 100.014C52.8716 100.014 53.1188 99.8608 53.2949 99.554C53.4711 99.2472 53.5591 98.8097 53.5591 98.2415C53.5591 97.8636 53.5186 97.5419 53.4377 97.2763C53.3581 97.0107 53.2431 96.8082 53.0925 96.669C52.9434 96.5298 52.7637 96.4602 52.5534 96.4602C52.2381 96.4602 51.9917 96.6158 51.8141 96.9268C51.6365 97.2365 51.5478 97.6747 51.5478 98.2415C51.5478 98.6193 51.5875 98.9403 51.6671 99.2045C51.7466 99.4687 51.861 99.6697 52.0101 99.8075C52.1607 99.9453 52.3418 100.014 52.5534 100.014Z" fill="black"/>
        <path d="M56.3034 100.483C55.9824 100.483 55.709 100.396 55.4831 100.221C55.2573 100.045 55.0847 99.7898 54.9654 99.456C54.8461 99.1207 54.7864 98.7159 54.7864 98.2415C54.7864 97.7699 54.8461 97.3672 54.9654 97.0334C55.0861 96.6982 55.2594 96.4425 55.4853 96.2663C55.7125 96.0888 55.9853 96 56.3034 96C56.6216 96 56.8936 96.0888 57.1195 96.2663C57.3468 96.4425 57.5201 96.6982 57.6394 97.0334C57.7601 97.3672 57.8205 97.7699 57.8205 98.2415C57.8205 98.7159 57.7608 99.1207 57.6415 99.456C57.5222 99.7898 57.3496 100.045 57.1238 100.221C56.8979 100.396 56.6245 100.483 56.3034 100.483ZM56.3034 100.014C56.6216 100.014 56.8688 99.8608 57.0449 99.554C57.2211 99.2472 57.3091 98.8097 57.3091 98.2415C57.3091 97.8636 57.2686 97.5419 57.1877 97.2763C57.1081 97.0107 56.9931 96.8082 56.8425 96.669C56.6934 96.5298 56.5137 96.4602 56.3034 96.4602C55.9881 96.4602 55.7417 96.6158 55.5641 96.9268C55.3865 97.2365 55.2978 97.6747 55.2978 98.2415C55.2978 98.6193 55.3375 98.9403 55.4171 99.2045C55.4966 99.4687 55.611 99.6697 55.7601 99.8075C55.9107 99.9453 56.0918 100.014 56.3034 100.014Z" fill="black"/>
        <path d="M32 20.25H22M32 22.25H22M32 24.25H22M32 26.25H22M32 30.25H22M32 32.25H22M32 34.25H22M32 36.25H22M32 40.25H22M32 42.25H22M32 44.25H22M32 46.25H22M32 50.25H22M32 52.25H22M32 54.25H22M32 56.25H22M32 60.25H22M32 62.25H22M32 64.25H22M32 66.25H22M32 70.25H22M32 72.25H22M32 74.25H22M32 76.25H22M32 80.25H22M32 82.25H22M32 84.25H22M32 86.25H22M32 90.25H22M32 92.25H22M32 94.25H22M32 96.25H22M42 18.25H22M37 28.25H22M42 38.25H22M37 48.25H22M42 58.25H22M37 68.25H22M42 78.25H22M37 88.25H22M42 98.25H22M22.25 18V98" stroke="black" stroke-width="0.5"/>
      </g>
      <g class={overflow() ? "" : "hidden"} transform="translate(4,-1)">
        <path d="M21 1C20.3333 2.9358 19.2586 4.87182 19 6.80762C18.987 6.90494 18.974 7.00228 18.9609 7.09961C18.343 11.6911 17.624 16.2835 17.5 20.875C16.6358 52.8833 15.9232 84.8921 15.1484 116.9C15.0992 118.934 15.0498 120.967 15 123H7C6.95023 120.967 6.90078 118.934 6.85156 116.9C6.07677 84.8921 5.36416 52.8833 4.5 20.875C4.37604 16.2835 3.65699 11.6911 3.03906 7.09961C3.02596 7.00228 3.013 6.90494 3 6.80762C2.74142 4.87182 1.66667 2.9358 1 1H21Z" fill="#78AEDD"/>
        <path d="M71 1C70.6667 2.9358 70.1293 4.87182 70 6.80762C69.9935 6.90495 69.987 7.00228 69.9805 7.09961C69.6715 11.6911 69.312 16.2835 69.25 20.875C68.8179 52.8833 68.4616 84.8921 68.0742 116.9C68.0496 118.934 68.0249 120.967 68 123H64C63.9751 120.967 63.9504 118.934 63.9258 116.9C63.5384 84.8921 63.1821 52.8833 62.75 20.875C62.688 16.2835 62.3285 11.6911 62.0195 7.09961C62.013 7.00228 62.0065 6.90495 62 6.80762C61.8707 4.87182 61.3333 2.9358 61 1H71Z" fill="#78AEDD"/>
        <path d="M80 1C79.8 2.9358 79.478 4.87182 79.4004 6.80762C79.3965 6.90495 79.3926 7.00228 79.3887 7.09961C79.2033 11.6911 78.9874 16.2835 78.9502 20.875C78.6909 52.8833 78.4766 84.8921 78.2441 116.9C78.2294 118.934 78.2151 120.967 78.2002 123H75.7998C75.7849 120.967 75.7706 118.934 75.7559 116.9C75.5234 84.8921 75.3091 52.8833 75.0498 20.875C75.0126 16.2835 74.7967 11.6911 74.6113 7.09961C74.6074 7.00228 74.6035 6.90495 74.5996 6.80762C74.522 4.87182 74.2 2.9358 74 1H80Z" fill="#78AEDD"/>
        <path d="M21 1C20.3333 2.9358 19.2586 4.87182 19 6.80762C18.987 6.90494 18.974 7.00228 18.9609 7.09961C18.343 11.6911 17.624 16.2835 17.5 20.875C16.6358 52.8833 15.9232 84.8921 15.1484 116.9C15.0992 118.934 15.0498 120.967 15 123H7C6.95023 120.967 6.90078 118.934 6.85156 116.9C6.07677 84.8921 5.36416 52.8833 4.5 20.875C4.37604 16.2835 3.65699 11.6911 3.03906 7.09961C3.02596 7.00228 3.013 6.90494 3 6.80762C2.74142 4.87182 1.66667 2.9358 1 1H21Z" stroke="black"/>
        <path d="M71 1C70.6667 2.9358 70.1293 4.87182 70 6.80762C69.9935 6.90495 69.987 7.00228 69.9805 7.09961C69.6715 11.6911 69.312 16.2835 69.25 20.875C68.8179 52.8833 68.4616 84.8921 68.0742 116.9C68.0496 118.934 68.0249 120.967 68 123H64C63.9751 120.967 63.9504 118.934 63.9258 116.9C63.5384 84.8921 63.1821 52.8833 62.75 20.875C62.688 16.2835 62.3285 11.6911 62.0195 7.09961C62.013 7.00228 62.0065 6.90495 62 6.80762C61.8707 4.87182 61.3333 2.9358 61 1H71Z" stroke="black"/>
        <path d="M80 1C79.8 2.9358 79.478 4.87182 79.4004 6.80762C79.3965 6.90495 79.3926 7.00228 79.3887 7.09961C79.2033 11.6911 78.9874 16.2835 78.9502 20.875C78.6909 52.8833 78.4766 84.8921 78.2441 116.9C78.2294 118.934 78.2151 120.967 78.2002 123H75.7998C75.7849 120.967 75.7706 118.934 75.7559 116.9C75.5234 84.8921 75.3091 52.8833 75.0498 20.875C75.0126 16.2835 74.7967 11.6911 74.6113 7.09961C74.6074 7.00228 74.6035 6.90495 74.5996 6.80762C74.522 4.87182 74.2 2.9358 74 1H80Z" stroke="black"/>
      </g>
    </g>
    <Portal mount={document.getElementById("cond-mask")!} isSVG={true}>
      <rect x={0} y={172 - val() / 25} width="20" height={(blocked() === 0) ? val() / 25 : 0} fill="black" />
    </Portal>
    <Portal mount={document.getElementById("conc-mask")!} isSVG={true}>
      <rect x={0} y={172 - val() / 25} width="20" height={(blocked() === 3) ? val() / 25 : 0} fill="black" />
    </Portal>
    <BeakerEmptyModal beakerRef={ref} display={modalDisplay} onDisplayChange={setModalDisplay} onEmptyClick={() => setVal(0)} />

  </>);
};

const BeakerFill: Component<{ vol: Accessor<number> }> = ({ vol }) => {
  return (<>
    <rect id="inBeakerFill" x="5" y={18 + 100 - vol() / 25} width="79" height={vol() / 25} fill="#3B8CCF" fill-opacity="0.6"/>
  </>);
}

const BeakerEmptyModal: Component<{ beakerRef: SVGGElement, display: Accessor<boolean>, onDisplayChange: (x: boolean) => void, onEmptyClick: () => void }> = ({ beakerRef, display, onDisplayChange, onEmptyClick }) => {

  const window_coords = createMemo(() => {
    if (!display() || !beakerRef) return {x:0,y:0};
    const bds = beakerRef.getBoundingClientRect();
    return { x: bds.x + bds.width/2 - 85, y: bds.y + bds.height + 2 };
  })

  // Turn own show off
  let ref!: HTMLDivElement;
  const clickOut = (e: MouseEvent) => {
    if (ref.contains(e.target as Node) ) return;
    document.removeEventListener("click", clickOut);
    onDisplayChange(false);
  }

  createEffect(() => {
    if (display()) {
      document.addEventListener("pointerdown", clickOut);
    }
  });

  return (<>
  <Portal mount={document.querySelector("body")!}>
    {display() && (
      <div ref={ref}
        style={{
          "position": "absolute",
          "left": `${window_coords().x}px`,
          "top": `${window_coords().y}px`,
          "width": "max-content",
          "background": "white",
          "border": "1px solid #ccc",
          "border-radius": "6px",
          "box-shadow": "0 2px 8px rgba(0,0,0,0.15)",
          "padding": "10px",
          "text-align": "center",
          "z-index": 1000,
        }}
      >
        <button
          style={{
            "padding": "4px 12px",
            "border-radius": "4px",
            "border": "1px solid #da3737ff",
            "background": "#da3737ff",
            "color": "white",
            "cursor": "pointer",
          }}
          onClick={onEmptyClick}
        >
          <i class="fa-solid fa-arrows-rotate" />&nbsp;
          empty beaker
        </button>
      </div>
    )}
  </Portal>
  </>);
}