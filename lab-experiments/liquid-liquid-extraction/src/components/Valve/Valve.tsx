import { getAngleFromDown, getSVGCoords, resolveProperty } from "../../ts/helpers";
import "./Valve.css";
import { createSignal, type Component } from "solid-js";

interface ValveProps {
  onLiftChange?: (lift: number) => void;
  x: number | (() => number);
  y: number | (() => number);
}

export const Valve: Component<ValveProps> = (props) => {
    const onLiftChange = props.onLiftChange;
    const x = resolveProperty(props.x);
    const y = resolveProperty(props.y);

    const maxAngle = -720; // Degrees for fully open
    const cx = 25.5;
    const cy = 36;

    // State
    const [currentAngle, setCurrentAngle] = createSignal(0); // in pixels, range from 0 (closed) to 20 (fully open)
    let isDragging = false;
    let prevTh = 0;

    // Begin drag
    const beginDrag = (e: MouseEvent) => {
        e.preventDefault();
        isDragging = true;
        const svgMozCoords = getSVGCoords(e);
        prevTh = getAngleFromDown({x:cx + x(), y:cy + y()}, {x:svgMozCoords.x, y:svgMozCoords.y});
        document.addEventListener("pointermove", onDrag);
        document.addEventListener("pointerup", endDrag);
    };

    // On drag
    const onDrag = (e: MouseEvent) => {
        if (!isDragging) return;

        // Calculate angle change
        const angle = currentAngle();
        const svgMozCoords = getSVGCoords(e);
        const th = getAngleFromDown({x:cx + x(), y:cy + y()}, {x:svgMozCoords.x, y:svgMozCoords.y});
        let deltaTh = th - prevTh; // Positive if moving up
        if (Math.abs(deltaTh) > 180) {
        // Handle wrap-around
        if (deltaTh > 0) {
            // Moving from 359 to 0
            deltaTh -= 360;
        } else {
            // Moving from 0 to 359
            deltaTh += 360;
        }
        }

        // Update angle with clamping
        let newAngle = angle + deltaTh;
        newAngle = Math.min(0, Math.max(maxAngle, newAngle)); // Clamp between 0 and 20

        // Update state and callback if changed
        if (newAngle !== angle) {
        setCurrentAngle(newAngle);
        onLiftChange?.(newAngle / maxAngle); // Normalize to [0, 1]
        }
        
        // Update previous angle
        prevTh = th;
    };

  // End drag
  const endDrag = () => {
    isDragging = false;
    document.removeEventListener("pointermove", onDrag);
    document.removeEventListener("pointerup", endDrag);
  };

  // Render
  return (
    <g id="globeValve" transform={`translate(${x()}, ${y()})`}>
        <rect x="31.5" y="9.5" width="54" height="12" transform="rotate(90 31.5 9.5)" fill="url(#paint0_linear_34_266)" stroke="black"/>
        <rect x="33.5" y="63.5" width="9" height="16" rx="0.5" transform="rotate(90 33.5 63.5)" fill="url(#paint1_linear_34_266)" stroke="black"/>
        <rect x="33.5" y="0.5" width="9" height="16" rx="0.5" transform="rotate(90 33.5 0.5)" fill="url(#paint2_linear_34_266)" stroke="black"/>
        <g transform={`rotate(${currentAngle()} ${cx} ${cy})`} class="drag-exempt globeValveHandle" onpointerdown={beginDrag} >
            <path fill-rule="evenodd" clip-rule="evenodd" d="M24.1697 11.4898C24.9364 10.8367 26.0636 10.8367 26.8303 11.4898L32.8456 16.6156C33.1741 16.8955 33.5824 17.0651 34.0126 17.0994L41.8902 17.7275C42.8944 17.8076 43.6922 18.6055 43.7724 19.6097L44.4005 27.4872C44.4348 27.9173 44.6044 28.3257 44.8843 28.6542L50.0101 34.6694C50.6633 35.4361 50.6633 36.5633 50.0101 37.33L44.8843 43.3453C44.6044 43.6738 44.4349 44.0821 44.4005 44.5123L43.7724 52.3897L43.7484 52.576C43.5909 53.4912 42.8315 54.1968 41.8902 54.2719L34.0126 54.9C33.5824 54.9344 33.1741 55.104 32.8456 55.3838L26.8303 60.5096L26.683 60.6248C25.9751 61.125 25.0249 61.125 24.317 60.6248L24.1697 60.5096L18.1544 55.3838C17.8669 55.139 17.5185 54.9783 17.1476 54.919L16.9874 54.9L9.10982 54.2719C8.10559 54.1918 7.30772 53.3939 7.22758 52.3897L6.5995 44.5123C6.56941 44.1358 6.43625 43.7756 6.21584 43.4715L6.11567 43.3453L0.98986 37.33C0.336731 36.5633 0.336696 35.4361 0.98986 34.6694L6.11567 28.6542C6.36055 28.3668 6.52123 28.0183 6.58047 27.6475L6.5995 27.4872L7.22758 19.6097C7.30776 18.6055 8.10561 17.8076 9.10982 17.7275L16.9874 17.0994C17.3638 17.0694 17.724 16.9362 18.0281 16.7158L18.1544 16.6156L24.1697 11.4898ZM20.5254 52.0291C20.5599 52.055 20.5947 52.0806 20.6286 52.1072L20.8159 52.2615L23.9613 54.9411V49.2454C23.239 49.1623 22.5342 49.0224 21.8517 48.8286L20.5254 52.0291ZM29.1473 48.8286C28.465 49.0222 27.7607 49.1624 27.0386 49.2454V54.9401L30.184 52.2615L30.3714 52.1072C30.4051 52.0807 30.4393 52.0549 30.4735 52.0291L29.1473 48.8286ZM13.1948 50.4805L17.3139 50.81C17.4374 50.8199 17.5604 50.8339 17.6826 50.8511L19.0078 47.6486C18.3796 47.2977 17.7842 46.8959 17.2238 46.4516L13.1948 50.4805ZM33.7752 46.4506C33.2146 46.8951 32.6196 47.2977 31.9911 47.6486L33.3174 50.8511C33.4396 50.8339 33.5625 50.8199 33.6861 50.81L37.8051 50.4805L33.7752 46.4506ZM10.6475 43.8171C10.6535 43.8598 10.6604 43.9024 10.6655 43.9453L10.6895 44.1857L11.0171 48.3057L15.048 44.2749C14.6036 43.7143 14.2009 43.1193 13.85 42.4908L10.6475 43.8171ZM37.149 42.4908C36.798 43.1194 36.3965 43.7152 35.952 44.2759L39.9809 48.3037L40.3104 44.1857C40.3203 44.0622 40.3343 43.9393 40.3515 43.8171L37.149 42.4908ZM28.1616 37.5384C27.8917 38.0042 27.5045 38.3914 27.0386 38.6613V46.142C31.472 45.4752 34.9755 41.9716 35.6424 37.5384H28.1616ZM15.3576 37.5384C16.0244 41.9715 19.5282 45.474 23.9613 46.141V38.6613C23.4955 38.3914 23.1083 38.0042 22.8384 37.5384H15.3576ZM9.23804 40.6837C9.31821 40.7778 9.39436 40.8749 9.46843 40.9732L12.6699 39.647C12.4764 38.9648 12.3362 38.2603 12.2532 37.5384H6.55743L9.23804 40.6837ZM38.7458 37.5384C38.6628 38.2604 38.5226 38.9647 38.329 39.647L41.5305 40.9732C41.6047 40.8747 41.6816 40.778 41.7619 40.6837L44.4415 37.5384H38.7458ZM9.46843 31.0252C9.3942 31.1238 9.3184 31.2214 9.23804 31.3157L6.55743 34.4611H12.2542C12.3372 33.7385 12.4761 33.0332 12.6699 32.3505L9.46843 31.0252ZM27.0386 33.3372C27.5047 33.607 27.8916 33.9951 28.1616 34.4611H35.6424C34.9755 30.0278 31.472 26.5232 27.0386 25.8564V33.3372ZM23.9613 25.8574C19.5282 26.5243 16.0245 30.028 15.3576 34.4611H22.8384C23.1084 33.9952 23.4954 33.607 23.9613 33.3372V25.8574ZM38.329 32.3515C38.5227 33.0337 38.6627 33.7381 38.7458 34.4601H44.4405L41.7619 31.3157C41.6814 31.2213 41.6049 31.1239 41.5305 31.0252L38.329 32.3515ZM10.6895 27.8137C10.6797 27.9373 10.6647 28.0602 10.6475 28.1824L13.85 29.5076C14.2008 28.8794 14.6027 28.284 15.047 27.7236L11.0171 23.6937L10.6895 27.8137ZM35.952 27.7226C36.3965 28.2831 36.798 28.8791 37.149 29.5076L40.3515 28.1814C40.3344 28.0595 40.3203 27.9369 40.3104 27.8137L39.9809 23.6947L35.952 27.7226ZM17.6815 21.1473C17.5596 21.1645 17.4372 21.1796 17.3139 21.1894L13.1938 21.517L17.2238 25.5479C17.7843 25.1034 18.3794 24.7008 19.0078 24.3498L17.6815 21.1473ZM31.9911 24.3498C32.6196 24.7007 33.2146 25.1035 33.7752 25.5479L37.8051 21.517L33.6861 21.1894C33.5625 21.1795 33.4397 21.1646 33.3174 21.1473L31.9911 24.3498ZM20.8159 19.7379C20.7216 19.8183 20.624 19.8941 20.5254 19.9683L21.8517 23.1698C22.5342 22.9761 23.2391 22.8361 23.9613 22.7531V17.0574L20.8159 19.7379ZM27.0386 22.7531C27.7609 22.8361 28.4658 22.9761 29.1483 23.1698L30.4735 19.9683C30.3752 19.8943 30.2781 19.8181 30.184 19.7379L27.0386 17.0574V22.7531Z" fill="#FF3B3B" stroke="black" stroke-linejoin="round"/>
        </g>
        <path d="M24.0176 36.8555V35.1455L25.5 34.2891L26.9824 35.1455V36.8555L25.5 37.7119L24.0176 36.8555Z" fill="#CECECE" stroke="black" stroke-width="0.5"/>

      {/* 
      <g id="feedValve" onpointerdown={beginDrag} >
        <circle cx="498" cy="629" r="20" fill="red" opacity={0} />
        <path
          id="valve"
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M514.391 610.729C515.395 610.809 516.192 611.606 516.272 612.61L516.901 620.488C516.936 620.919 517.104 621.327 517.384 621.656L522.51 627.67C523.164 628.437 523.164 629.565 522.51 630.332L517.384 636.346C517.105 636.675 516.936 637.083 516.901 637.514L516.272 645.392C516.192 646.396 515.395 647.193 514.391 647.273L506.513 647.902C506.083 647.936 505.674 648.105 505.346 648.385L499.332 653.511L499.183 653.626C498.424 654.161 497.388 654.123 496.67 653.511L490.655 648.385C490.327 648.105 489.918 647.936 489.488 647.902L481.61 647.273L481.424 647.25C480.57 647.103 479.898 646.431 479.751 645.577L479.729 645.391L479.1 637.513C479.07 637.137 478.937 636.777 478.716 636.473L478.617 636.346L473.49 630.332C472.837 629.565 472.837 628.437 473.49 627.67L478.617 621.656C478.861 621.368 479.022 621.019 479.081 620.648L479.1 620.488L479.729 612.61C479.809 611.606 480.606 610.809 481.61 610.729L489.488 610.1C489.864 610.07 490.224 609.937 490.528 609.717L490.655 609.617L496.669 604.491C497.436 603.837 498.565 603.837 499.331 604.491L505.346 609.617C505.633 609.862 505.982 610.022 506.353 610.082L506.513 610.1L514.391 610.729ZM483.148 636.818C483.154 636.861 483.161 636.903 483.166 636.946L483.19 637.188L483.519 641.306L487.546 637.279C487.094 636.709 486.695 636.112 486.349 635.493L483.148 636.818ZM491.508 640.651C490.889 640.306 490.292 639.907 489.722 639.455L485.696 643.482L489.814 643.812L490.055 643.835C490.098 643.84 490.14 643.846 490.183 643.852L491.508 640.651ZM479.06 630.539L481.74 633.685C481.82 633.779 481.897 633.876 481.971 633.975L485.173 632.647C484.977 631.955 484.84 631.25 484.758 630.539L479.06 630.539ZM496.462 642.242C495.751 642.16 495.046 642.024 494.353 641.828L493.027 645.03C493.125 645.104 493.222 645.181 493.316 645.262L496.462 647.941L496.462 642.242ZM481.97 624.026C481.944 624.061 481.919 624.096 481.893 624.13L481.74 624.317L479.058 627.462L484.758 627.462C484.841 626.751 484.976 626.045 485.173 625.353L481.97 624.026ZM501.648 641.828C500.955 642.024 500.25 642.162 499.539 642.244L499.54 647.941L502.685 645.262C502.779 645.181 502.876 645.104 502.974 645.03L501.648 641.828ZM498.795 631.971C498.274 632.109 497.727 632.109 497.206 631.971L491.917 637.261C495.523 639.924 500.478 639.924 504.084 637.261L498.795 631.971ZM489.741 622.917C487.078 626.523 487.078 631.478 489.741 635.084L495.03 629.795C494.892 629.275 494.892 628.727 495.03 628.207L489.741 622.917ZM483.189 620.814C483.18 620.937 483.165 621.06 483.148 621.182L486.349 622.508C486.695 621.888 487.094 621.291 487.546 620.722L483.518 616.694L483.189 620.814ZM506.279 639.455C505.709 639.907 505.112 640.306 504.493 640.651L505.819 643.853C505.941 643.836 506.064 643.822 506.187 643.812L510.306 643.483L506.279 639.455ZM490.182 614.147C490.06 614.165 489.937 614.18 489.814 614.19L485.694 614.518L489.722 618.547C490.292 618.095 490.889 617.694 491.509 617.348L490.182 614.147ZM500.971 628.206C501.11 628.727 501.109 629.275 500.97 629.795L506.26 635.085C508.923 631.478 508.924 626.523 506.261 622.916L500.971 628.206ZM504.084 620.741C500.478 618.078 495.523 618.078 491.917 620.741L497.206 626.031C497.727 625.892 498.275 625.892 498.795 626.03L504.084 620.741ZM509.652 635.493C509.306 636.112 508.907 636.709 508.455 637.278L512.482 641.305L512.811 637.188C512.821 637.064 512.836 636.941 512.853 636.819L509.652 635.493ZM493.316 612.74C493.222 612.82 493.124 612.897 493.026 612.971L494.353 616.172C495.046 615.976 495.751 615.839 496.461 615.757L496.461 610.058L493.316 612.74ZM511.244 630.539C511.162 631.249 511.024 631.955 510.828 632.647L514.03 633.974C514.105 633.876 514.181 633.779 514.261 633.685L516.941 630.539L511.244 630.539ZM502.974 612.97C502.876 612.896 502.779 612.82 502.685 612.74L499.54 610.058L499.539 615.758C500.249 615.84 500.955 615.976 501.648 616.173L502.974 612.97ZM510.828 625.353C511.024 626.046 511.16 626.751 511.243 627.462L516.942 627.461L514.261 624.317C514.181 624.222 514.105 624.125 514.03 624.026L510.828 625.353ZM506.187 614.19C506.064 614.18 505.941 614.165 505.819 614.147L504.493 617.349C505.112 617.695 505.71 618.094 506.279 618.546L510.307 614.519L506.187 614.19ZM508.455 620.722C508.907 621.292 509.307 621.889 509.652 622.508L512.853 621.182C512.836 621.06 512.821 620.937 512.811 620.814L512.483 616.695L508.455 620.722Z"
          fill="#FF3B3B"
          stroke="black"
          stroke-linejoin="round"
        />
        <path
          id="feedValveCenter"
          d="M496.518 629.855V628.146L498 627.289L499.483 628.146V629.855L498 630.712L496.518 629.855Z"
          fill="#CECECE"
          stroke="black"
          stroke-width="0.5"
        />
      </g> */}
    </g>
)};

export default Valve;